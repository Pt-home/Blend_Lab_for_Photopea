<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blend Lab – Photopea Plugin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151823; --line:#24283b;
      --text:#e6e6ea; --muted:#9aa0a6;
      --accent:#00a592; /* requested accent for actions (white text) */
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--panel); color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{ padding:12px; width:100%; max-width:520px; margin:0 auto; }
    h1{ font-size:16px; margin:0 0 6px; text-align:center; }
    p{ margin:0 0 10px; color:var(--muted); text-align:center; }

    .btn{
      width:100%; border:0; border-radius:10px; padding:10px 12px;
      cursor:pointer; font-weight:600; background:var(--accent); color:#fff;
      transition:filter .12s, transform .04s;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn:active{ transform:translateY(1px); }

    .stack{ display:flex; flex-direction:column; gap:8px; }
    .note{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; }
    .sep{ height:1px; background:var(--line); margin:10px 0; opacity:.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Blend Lab for Photopea</h1>
    <p>Send the active layer to Blend Lab, experiment with per-channel blending, then export back as a new Photopea document.</p>

    <div class="sep"></div>

    <div class="stack">
      <button id="sendBaseBtn"  class="btn">Send to Lab as base</button>
      <button id="sendBlendBtn" class="btn">Send to Lab as blend</button>
    </div>

    <div class="note" id="status">Ready.</div>
  </div>

  <script>
  (function(){
    // ---------------- Config ----------------
    // Fixed generator URL + per-session tab (one tab per plugin session)
    const LAB_URL = "https://pt-home.github.io/Blend_Lab_for_Photopea/";
    const PHOTOPEA_ORIGIN = "https://www.photopea.com";
    const LAB_ORIGIN = "https://pt-home.github.io";

    // Handshake / retry timings
    const READY_TIMEOUT_MS   = 1800;
    const READY_RETRIES      = 2;
    const APPLIED_TIMEOUT_MS = 1300;
    const APPLIED_RETRIES    = 1;

    // ---------------- State ----------------
    let sessionId = null;
    let labWin = null;         // handle to generator tab
    let labIsReady = false;    // did Lab respond with LAB_READY?

    let pendingPng = null;     // last PNG buffer to deliver (ArrayBuffer)
    let pendingName = "from-photopea.png";
    let pendingRole = null;    // "base" | "blend"
    let pendingSeq = -1;       // last send seq id
    let seqCounter = 0;        // monotonically increasing seq for LAB_IMAGE
    let appliedTimer = null;   // retry timer
    let appliedTries = 0;      // retries for APPLIED

    const statusEl     = document.getElementById("status");
    const sendBaseBtn  = document.getElementById("sendBaseBtn");
    const sendBlendBtn = document.getElementById("sendBlendBtn");

    // ---------------- Helpers ----------------
    const setStatus = (m)=> { statusEl.textContent = m; };

    function ensureSession(){
      // Persist within plugin frame lifetime; reuse if re-clicked
      try{
        sessionId = sessionStorage.getItem("blendlab-sessionId") || null;
      }catch(_){}
      if (!sessionId) {
        sessionId = "sess-" + Math.random().toString(36).slice(2);
        try{ sessionStorage.setItem("blendlab-sessionId", sessionId); }catch(_){}
      }
      return sessionId;
    }

    function openOrFocusLab(){
      ensureSession();
      const url = LAB_URL + "?sessionId=" + encodeURIComponent(sessionId);
      const target = "blendlab-" + sessionId; // one tab per session
      if (!labWin || labWin.closed) {
        labWin = window.open(url, target);
        labIsReady = false;
        setStatus("Opening Blend Lab…");
      } else {
        try { labWin.focus(); } catch(_){}
        sendLAB_OPEN(); // re-announce presence
        setStatus("Blend Lab focused.");
      }
    }

    function sendLAB_OPEN(){
      if (!labWin || labWin.closed) return;
      const msg = { type:"LAB_OPEN", sessionId };
      labWin.postMessage(msg, LAB_ORIGIN);
    }

    // ---------------- Ask Photopea for ACTIVE LAYER as PNG ----------------
    function askPhotopeaForActiveLayer(){
      // Copy active layer → new temp doc → paste → trim transparent → saveToOE("png") → close
      const script = `
      (function(){
        try{
          var src = app.activeDocument;
          if (!src){ app.echoToOE("pp:err:no-doc"); return; }
          var ly = src.activeLayer;
          if (!ly){ app.echoToOE("pp:err:no-active-layer"); return; }

          try { ly.copy(); app.echoToOE("pp:copy"); }
          catch(e){ app.echoToOE("pp:err:copy:"+e); return; }

          var w = src.width  || 1024;
          var h = src.height || 1024;
          var res  = src.resolution || 72;
          var mode = src.mode || "RGB";
          if (typeof mode !== "string") mode = "RGB";

          var tmp = app.documents.add(w, h, res, "BL Temp", mode);

          try { tmp.paste(); app.echoToOE("pp:paste"); }
          catch(e){ app.echoToOE("pp:err:paste:"+e); try{ tmp.close(); }catch(_){} return; }

          try { tmp.trimTransparent(); } catch(e){}
          try { tmp.saveToOE("png"); app.echoToOE("pp:saveToOE"); }
          catch(e){ app.echoToOE("pp:err:saveToOE:"+e); }

          try { tmp.close(); } catch(e){}

          try { app.activeDocument = src; } catch(e){}

          app.echoToOE("pp:done");
        }catch(err){
          app.echoToOE("pp:err:outer:"+err);
        }
      })();
      `;
      window.parent.postMessage(script, PHOTOPEA_ORIGIN);
      setStatus("Requesting active layer from Photopea…");
    }

    // ---------------- Send image to Lab (with seq + role) ----------------
    function sendImageToLab(){
      if (!labWin || labWin.closed) { setStatus("Lab tab is not available."); return; }
      if (!pendingPng) { setStatus("No image to send."); return; }

      pendingSeq = ++seqCounter;
      appliedTries = 0;
      if (appliedTimer) { clearTimeout(appliedTimer); appliedTimer = null; }

      const msg = {
        type: "LAB_IMAGE",
        sessionId,
        seq: pendingSeq,
        role: pendingRole,              // "base" | "blend"
        mime: "image/png",
        name: pendingName,
        buffer: pendingPng              // not transferring ownership → safe to retry
      };
      labWin.postMessage(msg, LAB_ORIGIN);
      waitForAppliedThenFocus();
    }

    function waitForAppliedThenFocus(){
      if (appliedTimer) clearTimeout(appliedTimer);
      appliedTimer = setTimeout(()=>{
        if (appliedTries >= APPLIED_RETRIES) {
          setStatus("Waiting for Blend Lab… (image not confirmed yet).");
          return;
        }
        appliedTries++;
        if (labWin && !labWin.closed && pendingPng && pendingSeq >= 0) {
          labWin.postMessage({
            type:"LAB_IMAGE", sessionId, seq: pendingSeq,
            role: pendingRole, mime:"image/png", name: pendingName, buffer: pendingPng
          }, LAB_ORIGIN);
          waitForAppliedThenFocus();
        }
      }, APPLIED_TIMEOUT_MS);
    }

    // ---------------- Wait for LAB_READY then send ----------------
    function waitForLabReadyThenSend(){
      let tries = 0;
      (function attempt(){
        if (labIsReady) { sendImageToLab(); return; }
        if (tries > READY_RETRIES) { setStatus("Blend Lab did not respond. Allow pop-ups and try again."); return; }
        tries++;
        sendLAB_OPEN();
        setTimeout(()=> labIsReady ? sendImageToLab() : attempt(), READY_TIMEOUT_MS);
      })();
    }

    // ---------------- UI events ----------------
    sendBaseBtn.addEventListener("click", ()=>{
      ensureSession();
      pendingRole = "base";
      pendingName = "base-from-photopea.png";
      openOrFocusLab();
      sendLAB_OPEN();
      askPhotopeaForActiveLayer();
    });

    sendBlendBtn.addEventListener("click", ()=>{
      ensureSession();
      pendingRole = "blend";
      pendingName = "blend-from-photopea.png";
      openOrFocusLab();
      sendLAB_OPEN();
      askPhotopeaForActiveLayer();
    });

    // ---------------- Message routing ----------------
    window.addEventListener("message", (ev)=>{
      // From Photopea (parent)
      if (ev.origin === PHOTOPEA_ORIGIN) {
        if (ev.data === "done") return;

        if (ev.data instanceof ArrayBuffer) {
          pendingPng = ev.data;
          setStatus("Image received from Photopea.");
          waitForLabReadyThenSend();
          return;
        }
        if (typeof ev.data === "string") {
          setStatus("Photopea: " + ev.data);
          return;
        }
      }

      // From Blend Lab (generator)
      if (ev.origin === LAB_ORIGIN) {
        const msg = ev.data || {};
        if (!msg || msg.sessionId !== sessionId) return;

        if (msg.type === "LAB_READY") {
          labIsReady = true;
          setStatus("Blend Lab is ready.");
          if (pendingPng) sendImageToLab();
          return;
        }

        if (msg.type === "LAB_IMAGE_APPLIED") {
          // accept only current seq
          if (typeof msg.seq === "number" && msg.seq === pendingSeq) {
            pendingPng = null;
            if (appliedTimer) { clearTimeout(appliedTimer); appliedTimer = null; }
            setStatus("Image applied in Blend Lab.");
            try { labWin && labWin.focus(); } catch(_){}
          }
          return;
        }

        if (msg.type === "LAB_EXPORT" && msg.buffer instanceof ArrayBuffer) {
          // Forward PNG back to Photopea → new document
          window.parent.postMessage(msg.buffer, PHOTOPEA_ORIGIN, [msg.buffer]);
          setStatus("Exported back to Photopea as a new document.");
          return;
        }
      }
    });

    // Initial status
    setStatus("Ready.");
  })();
  </script>
</body>
</html>
